<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Applications - Freelancer Marketplace</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav id="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">Freelancer<span>.</span></a>
            <button class="mobile-menu-btn" aria-label="Toggle menu">☰</button>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="browse-freelancers.html">Browse Freelancers</a></li>
                <li><a href="post-job.html">Post a Job</a></li>
                <li><a href="login.html" class="btn-login-nav">Login</a></li>
                <li><a href="signup.html" class="btn-signup-nav">Sign Up</a></li>
            </ul>
        </div>
    </nav>

    <div class="page-header">
        <h1>My Applications</h1>
        <p>Track your job applications and offers</p>
    </div>

    <main>
        <section class="section my-applications-section">
            <div class="applications-filter">
                <button class="filter-btn active" onclick="filterApplications('all')">All</button>
                <button class="filter-btn" onclick="filterApplications('pending')">Pending</button>
                <button class="filter-btn" onclick="filterApplications('hired')">Hired</button>
                <button class="filter-btn" onclick="filterApplications('rejected')">Rejected</button>
            </div>

            <div id="myApplicationsContainer" class="my-applications-grid">
                <!-- Loaded dynamically -->
            </div>
        </section>
    </main>

    <button class="scroll-to-top" id="scrollToTop" aria-label="Scroll to top">↑</button>

    <footer>
        <div class="social-icons">
            <a href="https://t.me/rundilundlegamera" target="_blank" rel="noopener noreferrer" aria-label="Telegram">
                <svg viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">
                    <path d="M 200.894531 323.863281 L 192.425781 442.988281 C 204.542969 442.988281 209.792969 437.78125 216.085938 431.53125 L 272.894531 377.238281 L 390.613281 463.445312 C 412.203125 475.476562 427.414062 469.140625 433.238281 443.585938 L 510.507812 81.515625 L 510.527344 81.492188 C 517.375 49.578125 498.988281 37.097656 477.953125 44.929688 L 23.765625 218.816406 C -7.230469 230.847656 -6.761719 248.128906 18.496094 255.957031 L 134.613281 292.074219 L 404.332031 123.308594 C 417.023438 114.902344 428.566406 119.550781 419.070312 127.957031 Z M 200.894531 323.863281 "></path>
                </svg>
            </a>
        </div>
        <p>&copy; <span id="current-year"></span> Freelancer Marketplace. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
        let allApplications = [];
        let currentFilter = 'all';

        async function loadMyApplications() {
            try {
                const user = JSON.parse(localStorage.getItem('user'));
                if (!user || user.userType !== 'freelancer') {
                    document.getElementById('myApplicationsContainer').innerHTML = '<p>Please login as a freelancer</p>';
                    return;
                }

                const response = await fetch(`/api/applications/freelancer/${user._id}`);
                const data = await response.json();
                
                if (data.success) {
                    allApplications = data.applications;
                    displayMyApplications(allApplications);
                }
            } catch (error) {
                console.error('[v0] Error loading applications:', error);
            }
        }

        function displayMyApplications(applications) {
            const container = document.getElementById('myApplicationsContainer');

            if (applications.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No applications yet</p>';
                return;
            }

            container.innerHTML = applications.map(app => `
                <div class="my-application-card">
                    <div class="app-card-header">
                        <h3>${app.jobTitle}</h3>
                        <span class="app-status ${app.status}">${app.status}</span>
                    </div>
                    <p class="app-client">Client: ${app.clientName}</p>
                    <p class="app-category">${app.jobCategory}</p>
                    <div class="app-card-details">
                        <div class="detail">
                            <span class="label">Budget:</span>
                            <span class="value">$${app.budget}</span>
                        </div>
                        <div class="detail">
                            <span class="label">Applied:</span>
                            <span class="value">${new Date(app.appliedAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                    ${app.status === 'hired' ? `
                        <div class="app-success-message">
                            Congratulations! You've been hired for this job.
                        </div>
                        <div class="app-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="acceptJob('${app._id}', '${app.jobTitle}')">✅ Accept Offer</button>
                            <button class="btn-secondary" onclick="declineJob('${app._id}')">❌ Decline</button>
                        </div>
                    ` : app.status === 'rejected' ? `
                        <div class="app-rejected-message">
                            Your application was not selected.
                        </div>
                    ` : app.status === 'accepted' ? `
                        <div class="app-success-message">
                            ✅ Offer accepted! Start working on this project.
                        </div>
                    ` : app.status === 'declined' ? `
                        <div class="app-rejected-message">
                            You declined this offer.
                        </div>
                    ` : `
                        <div class="app-pending-message">
                            Waiting for client response...
                        </div>
                    `}
                </div>
            `).join('');
        }

        function filterApplications(status) {
            currentFilter = status;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter and display
            const filtered = status === 'all' 
                ? allApplications 
                : allApplications.filter(app => app.status === status);

            displayMyApplications(filtered);
        }

        async function acceptJob(applicationId, jobTitle) {
            if (!confirm(`Accept the offer for "${jobTitle}"?`)) return;

            try {
                const response = await fetch(`/api/applications/${applicationId}/accept`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Offer accepted! You can now start working on this project.');
                    loadMyApplications();
                } else {
                    alert(data.error || 'Error accepting offer');
                }
            } catch (error) {
                console.error('Error accepting offer:', error);
                alert('Error accepting offer');
            }
        }

        async function declineJob(applicationId) {
            if (!confirm('Are you sure you want to decline this offer?')) return;

            try {
                const response = await fetch(`/api/applications/${applicationId}/decline`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Offer declined.');
                    loadMyApplications();
                } else {
                    alert(data.error || 'Error declining offer');
                }
            } catch (error) {
                console.error('Error declining offer:', error);
                alert('Error declining offer');
            }
        }

        document.addEventListener('DOMContentLoaded', loadMyApplications);
    </script>
</body>
</html>
